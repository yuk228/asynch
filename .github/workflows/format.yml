name: Lint and Format
on: [pull_request]
jobs:
  prettier:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
      - uses: technote-space/get-diff-action@v6
        with:
          PATTERNS: |
            **/*.{ts,tsx,js,jsx,json}
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: cd frontend && bun install --frozen-lockfile
      - name: Run Prettier Format
        run: bunx prettier --write ${{ env.GIT_DIFF_FILTERED }}
        if: env.GIT_DIFF
      - uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: Apply Prettier Change
  Summary:
    if: always()
    needs: prettier
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: get-diff
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
        run: |
          # PRã®å·®åˆ†ã‚’å–å¾—ï¼ˆæœ€å¤§10ãƒ•ã‚¡ã‚¤ãƒ«ã¾ã§ï¼‰
          DIFF=$(gh pr diff ${{ github.event.pull_request.number }} | head -c 50000)
          
          # å·®åˆ†ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆJSONç”¨ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼‰
          echo "$DIFF" > diff.txt
          
          # JSONãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½œæˆ
          jq -n --rawfile content diff.txt '{content: $content}' > payload.json

      - name: Send to API
        id: api-request
        env:
          API_URL: ${{ secrets.API_URL }}
        run: |
          # URLå¤‰æ•°ã®ãƒã‚§ãƒƒã‚¯ï¼ˆå€¤ã®ä¸­èº«ã¯å‡ºã•ãšã«ãƒã‚§ãƒƒã‚¯ï¼‰
          if [ -z "$API_URL" ]; then
            echo "Error: API_URL secret is empty or not set."
            exit 1
          fi
          echo "API_URL length: ${#API_URL}"

          # APIã«POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã¨ãƒœãƒ‡ã‚£ã‚’å–å¾—ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ã« -v ã‚’ä½¿ç”¨ï¼‰
          HTTP_STATUS=$(curl -v -w "%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -d @payload.json \
            -o response.txt \
            "$API_URL")
          
          echo "API Response Status: $HTTP_STATUS"
          cat response.txt
          
          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "Error: API request failed with status $HTTP_STATUS"
            exit 1
          fi
          
          # GitHub Actionsã®å‡ºåŠ›ã¨ã—ã¦è¨­å®š
          {
            echo "response<<EOF"
            cat response.txt
            echo ""
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Comment on PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
        if: steps.api-request.outputs.response != ''
        run: |
          # APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰summaryã‚’å–ã‚Šå‡ºã—ã¦Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
          jq -r .summary response.txt > comment.md
          
          # Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆ
          echo "## ğŸ¤– Code Review API Response" > body.md
          echo "" >> body.md
          cat comment.md >> body.md
          
          gh pr comment ${{ github.event.pull_request.number }} --body-file body.md
