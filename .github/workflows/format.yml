name: Lint and Format
on: [pull_request]
jobs:
  prettier:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
      - uses: technote-space/get-diff-action@v6
        with:
          PATTERNS: |
            **/*.{ts,tsx,js,jsx,json}
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: cd frontend && bun install --frozen-lockfile
      - name: Run Prettier Format
        run: bunx prettier --write ${{ env.GIT_DIFF_FILTERED }}
        if: env.GIT_DIFF
      - uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: Apply Prettier Change
  Summary:
    if: always()
    needs: prettier
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: get-diff
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
        run: |
          # PRã®å·®åˆ†ã‚’å–å¾—ï¼ˆæœ€å¤§10ãƒ•ã‚¡ã‚¤ãƒ«ã¾ã§ï¼‰
          DIFF=$(gh pr diff ${{ github.event.pull_request.number }} | head -c 50000)
          
          # å·®åˆ†ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆJSONç”¨ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼‰
          echo "$DIFF" > diff.txt
          
          # JSONãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½œæˆ
          jq -n --rawfile content diff.txt '{content: $content}' > payload.json

      - name: Send to API
        id: api-request
        run: |
          # APIã«POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã¨ãƒœãƒ‡ã‚£ã‚’å–å¾—
          HTTP_STATUS=$(curl -s -w "%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -d @payload.json \
            -o response.txt \
            "https://z1waaaafg5.execute-api.ap-northeast-1.amazonaws.com/prod")
          
          echo "API Response Status: $HTTP_STATUS"
          cat response.txt
          
          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "Error: API request failed with status $HTTP_STATUS"
            exit 1
          fi
          
          # GitHub Actionsã®å‡ºåŠ›ã¨ã—ã¦è¨­å®š
          echo "response<<EOF" >> $GITHUB_OUTPUT
          cat response.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment on PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
        if: steps.api-request.outputs.response != ''
        run: |
          # APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆ
          gh pr comment ${{ github.event.pull_request.number }} --body "## ğŸ¤– Code Review API Response
          
          $(cat response.txt)
          "
